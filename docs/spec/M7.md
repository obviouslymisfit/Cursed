# CURSED — Milestone M7
## Run Resolution & End Conditions

---

## 0. CRITICAL IMPLEMENTATION RULE (APPLIES TO THIS AND ALL FUTURE MILESTONES)

When implementing this milestone (and every milestone thereafter):

- **All non-trivial code MUST include explicit, explanatory comments**
- Comments must:
  - explain **what the code does**
  - explain **why it exists**
  - explain **how it fits into the larger system**
- Comments must be written so that:
  - a third party with no prior context
  - or a future maintainer months/years later  
    can understand the intent and structure without external documentation

This is not optional.  
Lack of clear comments is considered incomplete implementation.

### COMMENTING RULE (CLARIFICATION — NON-NEGOTIABLE)

- Comments are written **at the moment code is created**, not afterward.
- There is **no separate “commenting phase”**.
- No class, method, or non-trivial logic may exist without comments explaining:
  - its responsibility
  - its boundaries
  - and why it exists at that location in the system.
- If a piece of code cannot be clearly commented while being written, implementation **must pause** and the design must be reconsidered.
- “We will add comments later” is considered **invalid and incomplete implementation**.

---

## 1. Purpose of M7

Milestone M7 introduces **run resolution logic**: the rules that determine when a run ends and how the outcome is decided.

M7 defines **win, loss, and manual termination conditions** at the run level and formalizes the concept of a run reaching a terminal state.

This milestone does **not** introduce rewards, punishments, score ranking, or post-run presentation. It strictly answers:

- When does the run end?
- Why did it end?
- What is the final outcome state?

M7 establishes a server-authoritative, immutable end to a run, forming the foundation for later milestones that handle rewards, penalties, and post-run systems.

---

## 2. Scope

### Included in M7
- A **Run Resolution Engine**
- Definition of terminal run states
- Explicit win and loss conditions
- Persistence of terminal outcome and reason
- Freeze semantics once a run ends
- Debug/admin inspection of run outcome
- Debug/admin ability to force-resolve a run

### Explicitly Excluded from M7
- Rewards, loot, or progression carry-over
- Score-based ranking or winner determination
- Post-run UI or summaries
- Curse cleanup, world reset, or rollback logic
- Automatic restart of new runs
- Balance tuning

M7 answers **“the run is over”**, not **“what happens next”**.

---

## 3. Terminal Run States

Once a terminal state is set, the run is considered finished permanently.

### 3.1 COMPLETED (Win)

Meaning:
- The run ended successfully.
- The primary success condition of the game has been met.
- No further progression logic may occur.

COMPLETED does **not** imply rewards or ranking — only that the run succeeded.

---

### 3.2 FAILED (Loss)

Meaning:
- A critical failure condition was reached.
- The run cannot continue meaningfully.
- The run is considered lost regardless of score or phase reached.

---

### 3.3 ABORTED (Manual Termination)

Meaning:
- The run was intentionally terminated by an admin/debug action.
- The run is neither a win nor a loss.
- Used for testing, recovery, or emergency shutdown.

ABORTED runs are excluded from reward or progression logic in later milestones.

---

### General terminal rules

- Exactly **one** terminal state may be assigned.
- Terminal state is **immutable** once set.
- Terminal state is **server-authoritative**.
- Terminal state is persisted immediately.
- Once terminal:
  - objectives cannot complete
  - tasks cannot complete
  - phases cannot advance
  - scoring is frozen
  - curses stop rotating and applying

---

## 4. Run Completion & Failure Conditions

### A. COMPLETED (Win) Conditions

The run is marked **COMPLETED** when **all** of the following are true:

1) **Final phase reached**
- The global phase has advanced to the maximum defined phase.

2) **Final PRIMARY objective completed**
- At least **one team** completes the PRIMARY objective of the final phase.
- Completion by any team is sufficient.

3) **Valid state**
- The run is currently RUNNING.
- The run is not already terminal.

When met:
- The run transitions atomically to COMPLETED.
- A resolution reason is recorded (e.g. `FINAL_PRIMARY_COMPLETED`).

---

### B. FAILED (Loss) Conditions

The run is marked **FAILED** when a **critical failure condition** is met.

M7 defines the framework but keeps exact tuning extensible.

#### Baseline failure hooks

1) **All teams eliminated / invalid**
- This condition exists as a **future hook only**.
- In M7:
  - There is **no elimination system**
  - Teams are **NOT invalidated by players being offline**
  - Offline or empty servers **must never** trigger failure
- This condition may only fire if an explicit team-invalid flag exists in the future.

2) **Hard phase failure**
- A phase may define a failure condition (e.g. timeout, exhaustion).
- M7 supports the hook; exact mechanics are defined later.

3) **Admin-forced failure**
- A debug/admin command explicitly marks the run as FAILED.

When FAILED:
- A failure reason is recorded (e.g. `PHASE_FAILURE`, `ADMIN_FORCE`).

---

### C. ABORTED

The run is marked **ABORTED** when:
- An admin/debug command explicitly aborts the run.

This bypasses win/loss evaluation entirely.

---

## 5. Resolution Mechanics & Persistence

### Resolution flow (atomic)

When a terminal condition is detected:

1) Lock run resolution
2) Set terminal outcome state
3) Record resolution reason
4) Freeze run state
5) Persist run state immediately
6) Release lock

### Freeze semantics

After terminal resolution:
- no objective/task completion allowed
- no phase advancement
- no scoring updates
- curse evaluation and rotation stop
- late events must be ignored safely

### Restart safety

- Terminal outcome and reason persist.
- On restart:
  - run remains terminal
  - no re-evaluation occurs
  - no progression resumes

### Idempotency

- Re-running resolution logic after terminal is a no-op.
- First terminal outcome always wins.

---

## 6. Debug & Admin Controls

All commands are debug/admin only and logged loudly.

### Required commands

1) **Show run outcome**
- Displays:
  - lifecycle state
  - terminal outcome
  - resolution reason
  - resolution tick/time

2) **Force complete**
- Marks run as COMPLETED
- Uses full resolution path

3) **Force fail**
- Marks run as FAILED
- Uses full resolution path

4) **Abort run**
- Marks run as ABORTED
- Uses full resolution path

5) **Clear terminal state (optional, debug-only)**
- Unsafe development-only tool
- Allows returning a terminal run to RUNNING
- Must be explicitly gated and never enabled in production

---

## 7. Implementation Steps (STRICT ORDER)

1. Add terminal outcome field to run state
2. Add resolution reason + timestamp fields
3. Implement resolution lock
4. Implement COMPLETED condition checks
5. Implement FAILED condition hooks (inactive by default)
6. Implement atomic resolution flow
7. Enforce freeze semantics across systems
8. Persist terminal state immediately
9. Implement debug/admin commands
10. **Verify that all code written during this milestone was commented at creation time**

---

## 8. Result After M7

- Runs now have a clear, immutable end
- Win and loss are formally defined
- No accidental failures from offline players
- All progression systems shut down safely on completion
- Foundation is ready for rewards, penalties, and post-run systems
