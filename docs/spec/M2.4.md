# CURSED — Milestone M2.4
## Spawn Platform Structure Placement (World Spawn Anchor)

---

## 0. CRITICAL IMPLEMENTATION RULE (APPLIES TO THIS AND ALL FUTURE MILESTONES)

All non-trivial code must include explicit, explanatory comments written at the moment the code is created.
Comments must explain what the code does, why it exists, and how it fits into the system.
“Comment later” is invalid and considered incomplete work.

---

## 1. Purpose

The spawn platform is the physical anchor of CURSED. It is where:
- players return between episodes
- delivery objectives are completed
- team chests live
- run end return teleport lands players
- scoreboard/coordination pressure is centered

To guarantee consistency across world seeds, the spawn platform must be shipped with the mod as a structure template and placed automatically on run creation / initialization.

This milestone defines how the platform is:
- loaded from a bundled NBT structure
- placed near world spawn
- placed safely on the surface (not underwater, not in caves, not floating)
- persisted as the canonical anchor position for all future systems

---

## 2. Locked Behavior (What MUST happen)

### 2.1 Platform ships with the mod as a structure file
- The platform is built by the developer using Creative mode and a Structure Block.
- It is exported as an NBT structure.
- The NBT is included in the mod resources so it is always available.

### 2.2 Platform placement happens once (run-scoped)
- The platform is placed once per run initialization.
- It is not placed every episode.
- It must never be duplicated due to restarts.

### 2.3 Platform is placed near Overworld spawn
- The search begins near the Overworld spawn position.
- “Near” is controlled by gameplay tuning knobs (search radius).

### 2.4 Platform must be placed safely on the surface
“Safely” means the placement location must satisfy all of the following:
- The structure’s footprint rests on solid ground (surface), not air.
- The footprint area is not underwater (no ocean/lake placement).
- The placement is not inside caves (i.e., it uses the surface height).
- The structure is not floating (no platform in mid-air).
- The structure is not buried deep underground.

This is a validation + retry search, not a single check.

### 2.5 Canonical platform anchor position is persisted
After placement, the mod must persist:
- the chosen platform origin position (anchor)
- a flag indicating placement is complete

All future systems must refer to this anchor position rather than recomputing spawn.

---

## 3. Placement Strategy (Conceptual)

The placement algorithm is a bounded search.

A recommended approach:
- Start from the Overworld spawn (x,z).
- Search candidate (x,z) positions in an expanding spiral or ring pattern.
- For each candidate:
    - compute surface Y using heightmap surface (not cave floor)
    - validate biome/water exposure in footprint
    - validate footprint stability (solid support under most/all blocks)
    - validate sufficient “build space” for the structure volume
- Choose the first valid candidate.
- If no valid candidate exists within bounds:
    - fall back to a safe reduced requirement strategy (last resort)
    - but must still avoid underwater placement if possible

The specific algorithm may vary as long as the locked safety outcomes are satisfied.

---

## 4. Footprint & Validation Requirements

The structure placement system must know:
- platform width/length footprint
- platform vertical bounds (height)

Validation must consider the entire footprint area, not a single block.

Minimum expectations:
- no water blocks in the footprint area at surface level
- surface Y across footprint should not vary beyond a small threshold (or else flattening logic is required)
- support blocks under footprint must be solid (stone/dirt/etc.), not fluid, not leaves

If terrain is uneven:
- either reject the candidate
- or explicitly flatten/prepare the area before placing the structure
  Flattening is allowed but must be deterministic and well-commented if used.

---

## 5. World Mutation Rules

Placement may require preparing the site.

Allowed actions (if documented):
- clearing non-solid blocks in the structure volume
- replacing water in footprint with solid blocks (only if explicitly desired)
- placing support blocks under the platform footprint if the structure requires it

Forbidden actions:
- large-scale terrain destruction
- random crater-like flattening
- anything that alters gameplay far beyond the platform area

The platform is an anchor, not a world-editing feature.

---

## 6. Configuration (Gameplay Knobs)

Platform placement parameters belong in gameplay config (not debug).

Proposed knobs:
- platform.enabled (boolean)
- platform.search.maxRadiusBlocks (int)
- platform.search.stepBlocks (int)
- platform.search.maxAttempts (int)
- platform.validation.maxHeightVariance (int)
- platform.sitePrep.allowFlatten (boolean)
- platform.sitePrep.allowSupportFill (boolean)

These are tuning knobs. The milestone defines the need even if defaults are used initially.

---

## 7. Persistence Requirements

The run state must store:
- platform anchor position (origin)
- platform placement completed flag

Restart safety:
- on server restart, the system must recognize the platform already exists and not place again.

---

## 8. Relationship to Other Milestones

This milestone must complete before:
- team chest placement/registration
- run-start team deployment (M2.5)
- delivery objective enforcement
- episode “return to platform” behavior
- run end return teleport behavior

The platform anchor position is the global reference point for multiple systems.

---

## 9. Implementation Checklist (Future Coding Chat Must Follow)

When implementing M2.4, the coding chat must:

1) Confirm where the structure NBT lives in resources and how it is loaded.
2) Confirm platform footprint dimensions for validation.
3) Implement the bounded search for a safe surface location near spawn.
4) Implement validation across the entire footprint.
5) Implement deterministic site preparation if needed (optional).
6) Place the structure once and persist the chosen anchor position.
7) Verify restart safety (no duplication).
8) Verify in multiple seeds that the platform is not underwater, not floating, not underground.
9) Ensure all code written is commented at creation time, with clear reasoning.

