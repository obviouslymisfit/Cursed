# CURSED — Milestone M8
## Run Outcome Finalization & Result Snapshot

---

## 0. CRITICAL IMPLEMENTATION RULE (APPLIES TO THIS AND ALL FUTURE MILESTONES)

When implementing this milestone (and every milestone thereafter):

- **All non-trivial code MUST include explicit, explanatory comments**
- Comments must:
  - explain **what the code does**
  - explain **why it exists**
  - explain **how it fits into the larger system**
- Comments must be written so that:
  - a third party with no prior context
  - or a future maintainer months/years later  
    can understand the intent and structure without external documentation

This is not optional.  
Lack of clear comments is considered incomplete implementation.

### COMMENTING RULE (CLARIFICATION — NON-NEGOTIABLE)

- Comments are written **at the moment code is created**, not afterward.
- There is **no separate “commenting phase”**.
- No class, method, or non-trivial logic may exist without comments explaining:
  - its responsibility
  - its boundaries
  - and why it exists at that location in the system.
- If a piece of code cannot be clearly commented while being written, implementation **must pause** and the design must be reconsidered.
- “We will add comments later” is considered **invalid and incomplete implementation**.

---

## 1. Purpose of M8

Milestone M8 finalizes a run after it becomes terminal (as defined in M7).

Its responsibility is to:
- interpret the already-frozen team scores (from M6)
- determine final standings and the winning team
- persist a complete, immutable snapshot of the run outcome
- expose the result for debugging and future systems

M8 does **not** modify scores, apply penalties, or grant rewards.  
All score changes happen live during the run. M8 only *reads* final state.

---

## 2. Scope

### Included in M8
- Winner determination from final team scores
- Deterministic standings ordering
- Deterministic tie-break rules
- Persistence of a final result snapshot
- Debug/admin inspection of final results
- Definition of extension hooks for future systems (no effects yet)

### Explicitly Excluded from M8
- Awarding or subtracting points
- Penalties or redistribution
- Rewards, loot, or meta progression
- Post-run UI or presentation
- Automatic restart or reset of runs
- Analytics dashboards or long-term statistics

---

## 3. Standings Ordering & Tie-break Rules

Final standings are computed deterministically once the run becomes terminal.

### Primary ordering
1) **Total team score** (higher is better)

### Tie-break rules (applied in order)
2) **Higher phase reached by the team** (if tracked)
3) **Earlier last score change tick**
4) **Stable deterministic fallback** (teamId ascending)

No random tie-breaking is allowed.

---

## 4. Result Snapshot Persistence Shape

At run resolution, a `finalResult` snapshot is persisted exactly once.

### Required fields

- `terminalOutcome`: COMPLETED | FAILED | ABORTED
- `terminalReason`: resolution reason code
- `resolvedAtTick`: tick/time of resolution
- `runId`
- `phaseReached`: final global phase
- `runDurationTicks` (if tracked)

### Winner & standings
- `winningTeamId`
  - may be null for FAILED or ABORTED runs
- `standings`: ordered list:
  - `teamId`
  - `rank`
  - `totalPoints`
  - `breakdown` (primary / secondary / tasks)
  - `phaseReachedByTeam` (optional)
  - `lastScoreChangeTick`

### Snapshot rules
- Written exactly once
- Immutable after creation
- Never recomputed
- Purely derived from frozen run state

---

## 5. Extension Hooks (No Effects Yet)

Hooks fire once after the final result snapshot is persisted.

### Defined hooks
- `onRunCompleted(finalResult)`
- `onRunFailed(finalResult)`
- `onRunAborted(finalResult)`

### Hook rules
- Server-side only
- Must not mutate run state
- Must not modify score
- Must not restart or reset runs
- Safe to call even if no listeners are registered

Hooks exist solely to provide clean attachment points for future milestones.

---

## 6. Debug & Admin Inspection

All commands are debug/admin only and read-only.

### Required commands

1) **Show final result**
- terminal outcome
- resolution reason
- resolution time
- winning team
- phase reached
- run duration

2) **Show final standings**
- ordered list of teams:
  - rank
  - teamId
  - total score
  - breakdown
  - phase reached by team (if available)

3) **Show team final result**
- final rank
- final score + breakdown
- phase reached
- last score change tick

Commands must function correctly after server restart.

---

## 7. Implementation Steps (STRICT ORDER)

1. Define `finalResult` data structure
2. Compute standings deterministically on run resolution
3. Apply tie-break rules
4. Persist final result snapshot atomically
5. Store winning team id
6. Add extension hook invocations
7. Implement debug/admin inspection commands
8. Ensure immutability and restart safety
9. **Verify that all code written during this milestone was commented at creation time**

---

## 8. Result After M8

- Every run ends with a clear, immutable outcome
- Winning team is deterministically resolved
- Final standings are persisted and inspectable
- No score mutation occurs post-run
- System is ready for future rewards, penalties, or meta layers without refactor
